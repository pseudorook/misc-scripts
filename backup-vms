#! /bin/bash
set -eu


#
# Define global variables and functions.
#

show_info() {
  echo -e "\033[1;32m$@\033[0m"
}
show_success() {
  echo -e "\033[1;35m$@\033[0m"
}
show_warning() {
  echo -e "\033[1;33m$@\033[0m"
}

SOURCE=${HOME}
DEST1=/run/media/quetzal/Aves/Images
DEST2=/run/media/quetzal/Avian/Images


#
# Backup VMs in home directory to Aves.
#

if ! [ -d ${DEST1} ]; then
  show_warning "Backup destination ${DEST1} does not exist."
  exit 1
fi

show_info "Syncing VMs in ${HOME} to Aves."
sudo bash -c "\
  rsync -Pradog --sparse \
    ${SOURCE}/.local/libvirt/images/ \
    ${DEST1}/KVM/ && \
  rsync -Pradog \
    ${SOURCE}/.VirtualBox/ \
    ${DEST1}/VirtualBox/"
sync
show_success "Done." && echo


#
# Backup VMs in Aves to Avian.
#

if [ -d ${DEST2} ]; then
  show_info "Syncing VMs in Aves to Avian."
  sudo bash -c "\
    rsync -Pradog --sparse \
      ${DEST1}/KVM/ \
      ${DEST2}/KVM/ && \
    rsync -Pradog \
      ${DEST1}/VirtualBox/ \
      ${DEST2}/VirtualBox/"
  sync
  show_success "Done." && echo
fi
